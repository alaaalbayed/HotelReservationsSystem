@model Domain.DTO_s.Reservation
@using Microsoft.AspNetCore.Mvc.Localization;
@using System.Globalization;
@using Ecommerce_App.Areas.Identity.Data;
@using Ecommerce_App.Areas.Identity.Pages.Account;
@using Microsoft.AspNetCore.Identity;

@inject SignInManager<Ecommerce_AppUser> SignInManager
@inject UserManager<Ecommerce_AppUser> UserManager

@inject IViewLocalizer localizer
@{
    ViewData["Title"] = "Create";
}

<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>uiCookies:Atlantis &mdash; Free Bootstrap Theme, Free Responsive Bootstrap Website Template</title>
    <meta name="description" content="Free Bootstrap Theme by uicookies.com">
    <meta name="keywords" content="free website templates, free bootstrap themes, free template, free bootstrap, free website template">

    <link href="https://fonts.googleapis.com/css?family=Crimson+Text:300,400,700|Rubik:300,400,700,900" rel="stylesheet">
    <link href="~/assets/hotel/css/custom.css" rel="stylesheet" />
    <link href="~/assets/hotel/css/style.min.css" rel="stylesheet" />
    <link href="~/assets/hotel/css/styles-merged.css" rel="stylesheet" />

    <!--[if lt IE 9]>
      <script src="js/vendor/html5shiv.min.js"></script>
      <script src="js/vendor/respond.min.js"></script>
    <![endif]-->

    <style>
        .checkbox-lg .form-check-input {
            top: .8rem;
            scale: 1.4;
            margin-right: 0.7rem;
        }

        .checkbox-lg .form-check-label {
            padding-top: 13px;
        }

        .checkbox-xl .form-check-input {
            top: 1.2rem;
            scale: 1.7;
            margin-right: 0.8rem;
        }

        .checkbox-xl .form-check-label {
            padding-top: 19px;
        }
    </style>
</head>
<body>

    <header role="banner" class="probootstrap-header ms-7">
        <!-- <div class="container"> -->
        <div class="row">
            <a asp-controller="Home" asp-action="Index" class="probootstrap-logo visible-xs"><img src="~/assets/hotel/img/logo_md.png" class="hires" width="120" height="33" /></a>

            <a href="#" class="probootstrap-burger-menu visible-xs"><i>Menu</i></a>
            <div class="mobile-menu-overlay"></div>

            <nav role="navigation" class="probootstrap-nav hidden-xs">
                <ul class="probootstrap-main-nav">
                    <li><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li><a href="#">About</a></li>
                    <li><a href="#">Our Rooms</a></li>
                    <li class="hidden-xs probootstrap-logo-center"><a asp-controller="Home" asp-action="Index"><img src="~/assets/hotel/img/logo_md.png" class="hires" width="181" height="50" /></a></li>
                    <li class="active"><a asp-controller="Home" asp-action="Reservation">Reservation</a></li>
                    <li><a href="#">Blog</a></li>
                    <li><a href="#">Contact</a></li>
                    @if (SignInManager.IsSignedIn(User))
                    {
                        var user = await SignInManager.UserManager.GetUserAsync(User);
                        <li class="nav-item dropdown">
                            <a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#" data-bs-toggle="dropdown">
                                <i class="align-middle" data-feather="settings"></i>
                            </a>
                            <a class="nav-link dropdown-toggle d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown">
                                @if (!string.IsNullOrEmpty(user?.Image))
                                {
                                    <img src="~/Images/@user.Image" class="avatar img-fluid rounded" alt="User Image" />
                                    <span class="text-dark">@user.FirstName @user.LastName</span>
                                }
                                else
                                {
                                    <img src="~/assets/img/avatars/default-avatar.jpg" class="avatar img-fluid rounded me-1" alt="Default Avatar" />
                                }

                            </a>
                            <div class="dropdown-menu dropdown-menu-end">
                                <a class="dropdown-item" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Page("/", new { area = "" })">LogOut</a>
                            </div>
                        </li>
                    }
                    else
                    {
                        <li>
                            <a asp-area="Identity" asp-page="/Account/Login">
                                <input type="button" value="SignIn" class="btn btn-primary">
                            </a>
                        </li>
                        <li>
                            <a asp-area="Identity" asp-page="/Account/Register">
                                <input type="button" value="SignUp" class="btn btn-primary">
                            </a>
                        </li>
                    }
                </ul>
                <div class="extra-text visible-xs">
                    <a href="#" class="probootstrap-burger-menu"><i>Menu</i></a>
                    <h5>Connect With Us</h5>
                    <ul class="social-buttons">
                        <li><a href="#"><i class="icon-twitter"></i></a></li>
                        <li><a href="#"><i class="icon-facebook2"></i></a></li>
                        <li><a href="#"><i class="icon-instagram2"></i></a></li>
                    </ul>
                </div>
            </nav>
        </div>
        <!-- </div> -->
    </header>
    <!-- END: header -->
    <section class="probootstrap-section">
        <div class="container">
            <div class="row probootstrap-gutter40">
                <div class="col-md-12">
                    <h2 class="mt0">Reservation Form</h2>
                    <form id="createForm" asp-action="Reservation" class="probootstrap-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="col-3 col-form-label required" asp-for="FullName"></label>
                                    <input type="text" class="form-control" asp-for="FullName" placeholder="Full Name">
                                    <span asp-validation-for="FullName" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="col-3 col-form-label required" asp-for="Nationality"></label>
                                <div class="col">
                                    <input type="text" class="form-control" asp-for="Nationality" placeholder="Nationality">
                                    <span asp-validation-for="Nationality" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="col-3 col-form-label required" asp-for="NationalityId"></label>
                                <div class="col">
                                    <input type="text" class="form-control" asp-for="NationalityId" placeholder="NationalityId">
                                    <span asp-validation-for="NationalityId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="col-3 col-form-label required" asp-for="PhoneNumber"></label>
                                <div class="col">
                                    <input type="number" class="form-control" asp-for="PhoneNumber" placeholder="Phone Number">
                                    <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label class="col-3 col-form-label required" asp-for="Email"></label>
                                <div class="col">
                                    <input type="email" class="form-control" asp-for="Email" placeholder="Email">
                                    <span asp-validation-for="Email" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="room">Room Type</label>
                                <div class="form-field">
                                    <select id="room" asp-for="RoomId" class="form-control">
                                        <option value="" selected disabled>Select a Room Type</option>
                                        @foreach (var room in Model.Rooms)
                                        {
                                            <option value="@room.Value">@room.Text</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="date-arrival">Arrival</label>
                                    <div class="form-field">
                                        <i class="icon icon-calendar2"></i>
                                        <input id="date-arrival" type="text" class="form-control" asp-for="CheckIn">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="date-departure">Departure</label>
                                    <div class="form-field">
                                        <i class="icon icon-calendar2"></i>
                                        <input id="date-departure" type="text" class="form-control" asp-for="CheckOut">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb30">
                            <div class="col-md-12 mt-5">
                                <label class="col-3 col-form-label required" asp-for="IsAdult"></label>
                                <div class="col form-check checkbox-xl">
                                    <input id="isAdultCheckbox" type="checkbox" class="form-check-input" asp-for="IsAdult">
                                    <span asp-validation-for="IsAdult" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-12 mt-5">
                                <label class="col-3 col-form-label required" asp-for="Breakfast"></label>
                                <div class="col form-check checkbox-xl">
                                    <input id="breakfastCheckbox" type="checkbox" class="form-check-input" asp-for="Breakfast">
                                    <span asp-validation-for="Breakfast" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-12 mt-5">
                                <label class="col-3 col-form-label required" asp-for="Lunch"></label>
                                <div class="col form-check checkbox-xl">
                                    <input id="lunchCheckbox" type="checkbox" class="form-check-input" asp-for="Lunch">
                                    <span asp-validation-for="Lunch" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-12 mt-5">
                                <label class="col-3 col-form-label required" asp-for="Dinner"></label>
                                <div class="col form-check checkbox-xl">
                                    <input id="dinnerCheckbox" type="checkbox" class="form-check-input" asp-for="Dinner">
                                    <span asp-validation-for="Dinner" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-12 mt-5">
                                <label class="col-3 col-form-label required" asp-for="ExtraBed"></label>
                                <div class="col form-check checkbox-xl">
                                    <input id="ExtraBed" type="checkbox" class="form-check-input" asp-for="ExtraBed">
                                    <span asp-validation-for="ExtraBed" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <div id="escortFields" class="form-group">
                                </div>
                            </div>
                            <div class="col-md-12 mt-5">
                                <label class="col-3 col-form-label">Price</label>
                                <div class="col">
                                    <span id="priceLabel" class="form-control-static">0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit">Reserve</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
    <!-- START: footer -->


    <script src="~/assets/hotel/js/scripts.js"></script>
    <script src="~/assets/hotel/js/custom.js"></script>
    <script src="~/assets/hotel/js/scripts.min.js"></script>
    <script src="~/assets/hotel/js/main.min.js"></script>
    <script src="~/assets/hotel/js/main.js"></script>

</body>
</html>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#room').change(function () {
                var selectedRoomId = $(this).val();

                $.ajax({
                    url: '/Home/GetRoomCapacity',
                    type: 'GET',
                    data: { roomId: selectedRoomId },
                    success: function (capacity) {
                        $('#capacity').text(capacity);

                        $('#escortFields').empty();

                        for (var i = 0; i < capacity - 1; i++) {
                            appendEscortInput(i);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("AJAX error:", error);
                    }
                });
            });

            function appendEscortInput(index) {
                var inputHtml = `
                                        <div class="mb-3 row mt-4">
                                            <label class="col-3 col-form-label required">Full Name</label>
                                            <div class="col">
                                                <input type="text" class="form-control" name="Escorts[${index}].FullName" placeholder="Full Name">
                                            </div>
                                            <div class="col">
                                                <div class="col">
                                                    <input type="hidden" name="Escorts[${index}].IsAdult" value="false">
                                                    <input type="checkbox" class="form-check-input escort-checkbox" name="Escorts[${index}].IsAdultCheckbox" id="escort_${index}_IsAdult">
                                                    <small class="form-hint mt-1">Is Adult</small>
                                                    <span class="text-danger" data-valmsg-for="Escorts[${index}].IsAdult" data-valmsg-replace="true"></span>
                                                </div>
                                            </div>
                                        </div>`;

                $('#escortFields').append(inputHtml);

                $(`#escort_${index}_IsAdult`).change(function () {
                    var isChecked = $(this).prop('checked');
                    $(`input[name="Escorts[${index}].IsAdult"]`).val(isChecked ? "true" : "false");
                    updatePrice();
                });
            }

            function updatePrice() {
                var selectedRoomNumber = $('#room').val();
                var isAdult = $('#isAdultCheckbox').prop('checked');
                var breakfast = $('#breakfastCheckbox').prop('checked');
                var lunch = $('#lunchCheckbox').prop('checked');
                var dinner = $('#dinnerCheckbox').prop('checked');
                var extraBed = $('#ExtraBed').prop('checked');
                var escortCheckboxes = $('.escort-checkbox:checked');
                var checkInDate = new Date($('#date-arrival').val());
                var checkOutDate = new Date($('#date-departure').val());
                if (isNaN(checkInDate) || isNaN(checkOutDate) || checkInDate >= checkOutDate) {
                    console.log('Invalid dates');
                    return;
                }

                var timeDifference = checkOutDate.getTime() - checkInDate.getTime();
                var daysBetween = Math.ceil(timeDifference / (1000 * 3600 * 24));

                $.ajax({
                    url: '/Home/GetRoomTypePrice',
                    type: 'GET',
                    data: { roomNumber: selectedRoomNumber },
                    success: function (data) {
                        console.log('Data from server:', data);


                        var adultPrice = isAdult ? (data.adultPrice || 0) : 0
                        var childrenPrice = isAdult ? (data.childrenPrice || 0) : 0;
                        var breakfastPrice = breakfast ? (data.breakfast || 0) : 0;
                        var lunchPrice = lunch ? (data.lunch || 0) : 0;
                        var dinnerPrice = dinner ? (data.dinner || 0) : 0;
                        var extraBedPrice = extraBed ? (data.extraBed || 0) : 0;
                        var escortPrice = 0;

                        escortCheckboxes.each(function () {
                            var isAdultEscort = $(this).prop('checked');
                            escortPrice += isAdultEscort ? adultPrice : childrenPrice;
                        });

                        var totalPrice = (isAdult ? adultPrice : childrenPrice) +
                            breakfastPrice + lunchPrice + dinnerPrice + extraBedPrice + escortPrice;

                        totalPrice *= daysBetween + 1;

                        $('#priceLabel').text(totalPrice.toFixed(2) + '$');
                    },
                    error: function (xhr, status, error) {
                        console.log("AJAX error:", error);
                    }
                });
            }

            $('#isAdultCheckbox, #breakfastCheckbox, #lunchCheckbox, #dinnerCheckbox, #ExtraBed, .escort-checkbox').change(updatePrice);

            function CheckDates() {
                var accDate = document.getElementById("date-arrival");
                var relDate = document.getElementById("date-departure");
                if (new Date(accDate.value) >= new Date(relDate.value) || new Date(accDate.value) < new Date()) {
                    document.getElementById("date-inval").style.display = "block!important";
                }
                else {
                    document.getElementById("date-inval").style.display = "none!important";
                }
            }
        });
    </script>
}



